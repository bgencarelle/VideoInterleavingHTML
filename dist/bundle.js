(()=>{var c=document.getElementById("displayCanvas"),C=c.getContext("2d"),g=document.createElement("canvas"),u=g.getContext("2d"),U=document.createElement("canvas"),H=U.getContext("2d");function D(o,e,t=!0){t&&u.clearRect(0,0,g.width,g.height),b(u,o),b(u,e),t&&C.clearRect(0,0,c.width,c.height),C.drawImage(g,0,0,c.width,c.height)}function _(){let o=window.devicePixelRatio||1,e=window.innerWidth,t=window.innerHeight;c.width=e*o,c.height=t*o,c.style.width=`${e}px`,c.style.height=`${t}px`,C.scale(o,o),g.width=e*o,g.height=t*o,g.style.width=`${e}px`,g.style.height=`${t}px`,u.scale(o,o),C.imageSmoothingEnabled=!1,u.imageSmoothingEnabled=!1}function b(o,e){let t=window.devicePixelRatio||1,i=o.canvas.width/t,n=o.canvas.height/t,l=i/n,r=e.width/e.height,s,d,h,m;r>l?(s=i,d=s/r,h=0,m=(n-d)/2):(d=n,s=d*r,h=(i-s)/2,m=0),s=Math.round(s),d=Math.round(d),h=Math.round(h),m=Math.round(m),o.drawImage(e,h,m,s,d)}_();var M=!1;window.addEventListener("resize",()=>{M||(M=!0,requestAnimationFrame(()=>{_(),M=!1}))});var S=30.303030303030305,p=12;var $="generated_img_lists/main_images.json",O="generated_img_lists/float_images.json";var I=class{constructor(){this.index=0,this.direction=1,this.listeners=[],this.frameTimes=[],this.lastLoggedIPS=-1,this.lastIndexChangeTime=performance.now()}setIndex(e,t){e>=0&&e<=t?(this.index=e,this.logIPS(),this.notifyListeners({indexChanged:!0})):console.warn(`Index out of bounds: ${e}`)}increment(e){let t=!1;this.index+=this.direction,this.index>e?(this.index=e,this.direction*=-1,t=!0):this.index<0&&(this.index=0,this.direction*=-1,t=!0),this.logIPS(),this.notifyListeners({directionChanged:t})}setDirection(e){e===1||e===-1?this.direction!==e&&(this.direction=e,this.notifyListeners({directionChanged:!0})):console.warn(`Invalid direction: ${e}`)}onIndexChange(e){this.listeners.push(e)}notifyListeners(e={}){this.listeners.forEach(t=>t(this.index,this.direction,e))}logIPS(){let e=performance.now(),t=e-this.lastIndexChangeTime;this.lastIndexChangeTime=e,this.frameTimes.push(t);let i=0;for(;this.frameTimes.length>0&&i+this.frameTimes[0]>10;)this.frameTimes.shift();i=this.frameTimes.reduce((l,r)=>l+r,0);let n=this.frameTimes.length/i*1e3;n!==this.lastLoggedIPS&&(console.log(`Index IPS: ${n.toFixed(2)}, index: ${this.index}, direction: ${this.direction}`),this.lastLoggedIPS=n)}getPreloadIndices(e){let t=[],i=Math.floor(e/2),n=this.index;for(let l=-i;l<=i;l++){let r=n+l;t.push(r)}return t}};var A=null;function f(o,e){return Math.floor(Math.random()*(e-o+1))+o}function v(o=[],e=60,t=0){t>0&&o.push(t),o.length>e&&o.shift();let i=o.reduce((l,r)=>l+r,0)/o.length||0;return{fps:i>0?Math.round(1e3/i):0,frameTimes:o}}function R(o){let e=document.getElementById("mode-overlay");e||(e=document.createElement("div"),e.id="mode-overlay",e.style.position="fixed",e.style.top="10px",e.style.right="10px",e.style.background="rgba(0,0,0,0.7)",e.style.color="#fff",e.style.padding="5px 10px",e.style.borderRadius="4px",e.style.fontFamily="sans-serif",e.style.fontSize="30px",e.style.transition="opacity 0.5s",e.style.opacity="1",document.body.appendChild(e)),e.textContent=o,e.style.opacity="1",A&&clearTimeout(A),A=setTimeout(()=>{e.style.opacity="0"},1e3)}var y=class{constructor(e,t){this.mainFolders=e,this.floatFolders=t,this.main_folder=0,this.float_folder=0,this.mode="RANDOM",this.rand_mult=f(1,9),this.rand_start=f(33,5*33),this.nextResetIndex=null,this.nextFloatFolderChangeIndex=null,this.nextMainFolderChangeIndex=null,this.lastKnownIndex=0,this.folderChangeSchedule=[{index:0,main_folder:this.main_folder,float_folder:this.float_folder}],this.pendingExternalChange=null,this.debounceTimer=null,this.debounceDelay=200,this.scheduleInitialFolderChanges(),this.scheduleFutureFolderChanges(0),this.precomputeFullCycleFolders(),this.listeners=[],this.lastDirection=null,this.setupExternalControlHooks()}setupExternalControlHooks(){document.addEventListener("keydown",e=>{let t=e.key.toLowerCase();if(t==="r"&&this.setMode("RANDOM"),t==="e"&&this.setMode("EXTERNAL"),t==="i"&&this.setMode("INCREMENT"),this.mode==="EXTERNAL"){let i=0,n=0;t==="q"&&(i=1),t==="a"&&(i=-1),t==="w"&&(n=1),t==="s"&&(n=-1),(i!==0||n!==0)&&this.queueExternalChange({mainDelta:i,floatDelta:n})}})}queueExternalChange(e){this.pendingExternalChange=e,this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.applyExternalChangeIfPending()},this.debounceDelay)}applyExternalChangeIfPending(){if(!this.pendingExternalChange)return;let{mainDelta:e,floatDelta:t}=this.pendingExternalChange;this.pendingExternalChange=null,this.main_folder=(this.main_folder+e)%this.mainFolders.length,this.main_folder<0&&(this.main_folder=this.mainFolders.length+this.main_folder),this.float_folder=(this.float_folder+t)%this.floatFolders.length,this.float_folder<0&&(this.float_folder=this.floatFolders.length+this.float_folder),this.applyManualFolderChange()}setMode(e){if(!["RANDOM","EXTERNAL","INCREMENT"].includes(e)){console.warn("[FolderController] Invalid mode requested:",e);return}this.mode!==e&&(this.mode=e,R(`Mode: ${this.mode}`))}applyManualFolderChange(){let e=this.lastKnownIndex||0;this.folderChangeSchedule.push({index:e,main_folder:this.main_folder,float_folder:this.float_folder}),this.notifyListeners({folderChanged:!0}),this.precomputeFullCycleFolders(),R(`External: Main=${this.main_folder}, Float=${this.float_folder}`)}scheduleInitialFolderChanges(){this.nextResetIndex=this.rand_start,this.nextFloatFolderChangeIndex=34*this.rand_mult,this.nextMainFolderChangeIndex=2+33*this.rand_mult}scheduleFutureFolderChanges(e){let t=this.folderChangeSchedule.length;if(this.folderChangeSchedule=this.folderChangeSchedule.filter(i=>i.index<=e),this.mode==="RANDOM"){let i=f(33,5*33),n=f(1,12),l=f(1,9),r=e+i;this.folderChangeSchedule.push({index:r,main_folder:0,float_folder:0});let s=e+34*n,d=f(0,this.floatFolders.length-1);this.folderChangeSchedule.push({index:s,main_folder:this.main_folder,float_folder:d});let h=e+(2+33*l),m=f(0,this.mainFolders.length-1);this.folderChangeSchedule.push({index:h,main_folder:m,float_folder:this.float_folder}),this.rand_start=i,this.rand_mult=l}this.precomputeFullCycleFolders()}findLatestChangeForIndex(e){let t=this.folderChangeSchedule,i=0,n=t.length-1,l=null;for(;i<=n;){let r=Math.floor((i+n)/2);t[r].index<=e?(l=t[r],i=r+1):n=r-1}return l}precomputeFullCycleFolders(){let e=this.getMaxIndex();this.precomputedFolderMap=new Array(e+1);for(let t=0;t<=e;t++){let i=this.findLatestChangeForIndex(t);i?this.precomputedFolderMap[t]={index:t,main_folder:i.main_folder,float_folder:i.float_folder}:this.precomputedFolderMap[t]={index:t,main_folder:this.main_folder,float_folder:this.float_folder}}}updateFolders(e,t){this.lastKnownIndex=e;let i=!1,n=this.main_folder,l=this.float_folder;if(this.mode==="RANDOM")e<this.rand_start||t===1&&e>10*this.rand_mult&&e<12*this.rand_mult?(this.float_folder=0,this.main_folder=0,this.rand_start=f(33,5*33),i=!0,this.nextResetIndex=e+this.rand_start):(this.rand_start=f(33,5*33),e%(34*this.rand_mult)===0&&(this.float_folder=f(0,this.floatFolders.length-1),this.rand_mult=f(1,12),i=!0,this.nextFloatFolderChangeIndex=e+34*this.rand_mult),e%(2+33*this.rand_mult)===0&&(this.main_folder=f(0,this.mainFolders.length-1),this.rand_mult=f(1,9),i=!0,this.nextMainFolderChangeIndex=e+(2+33*this.rand_mult)));else if(this.mode!=="EXTERNAL"){if(this.mode==="INCREMENT"){let r=!1;e>0&&e%33===0&&(this.main_folder=(this.main_folder+1)%this.mainFolders.length,r=!0);let s=Math.floor(33/2);s>0&&e>0&&e%s===0&&(this.float_folder=(this.float_folder+1)%this.floatFolders.length,r=!0),r&&(i=!0,this.folderChangeSchedule.push({index:e,main_folder:this.main_folder,float_folder:this.float_folder}),this.precomputeFullCycleFolders())}}this.mode==="RANDOM"&&i?(this.folderChangeSchedule.push({index:e,main_folder:this.main_folder,float_folder:this.float_folder}),this.scheduleFutureFolderChanges(e),this.notifyListeners({folderChanged:!0})):(this.mode==="EXTERNAL"||this.mode==="INCREMENT")&&i&&this.notifyListeners({folderChanged:!0}),this.lastDirection===null?this.lastDirection=t:(e===0&&this.lastDirection,this.lastDirection=t)}getMaxIndex(){return this.mainFolders[this.main_folder].image_list.length-1}onFolderChange(e){this.listeners.push(e)}notifyListeners(e={}){this.listeners.forEach(t=>t(e))}getPreloadInfo(e){let t=this.getMaxIndex();return e.map(i=>{i<0&&(i=0),i>t&&(i=t);let n=this.precomputedFolderMap[i];return n||{index:i,main_folder:this.main_folder,float_folder:this.float_folder}})}};async function z(o){let e=encodeURI(o);try{let t=await fetch(e);if(!t.ok)return console.error(`Failed to fetch image: ${o}, status: ${t.status}`),null;let i=await t.blob();try{return await createImageBitmap(i)}catch(n){return console.error(`Failed to decode image bitmap: ${o}`,n),null}}catch(t){return console.error(`Network error while fetching image: ${o}`,t),null}}var E=class{constructor(e,t={}){this.size=e,this.cache=new Map,this.indexController=t.indexController,this.folderController=t.folderController,this.mainFolders=t.mainFolders,this.floatFolders=t.floatFolders,this.isPreloading=!1}set(e,t){if(this.cache.size>=this.size){let i=this.cache.keys().next().value;this.cache.delete(i)}this.cache.set(e,t)}get(e){return this.cache.get(e)}has(e){return this.cache.has(e)}clear(){this.cache.clear()}sizeCurrent(){return this.cache.size}async preloadImages(){if(!this.isPreloading){this.isPreloading=!0;try{let e=this.indexController.getPreloadIndices(p),t=this.folderController.getPreloadInfo(e);for(let i of t){let{index:n,main_folder:l,float_folder:r}=i,s=this.mainFolders[l];if(!s||!Array.isArray(s.image_list)||s.image_list.length===0)continue;let d=s.image_list.length-1;if(n<0?n=0:n>d&&(n=d),this.has(n))continue;let h=this.floatFolders[r];if(!h||!Array.isArray(h.image_list)||h.image_list.length===0)continue;let m=s.image_list,T=h.image_list,q=n%m.length,B=n%T.length,N=m[q],P=T[B];if(!(!N||!P))try{let[F,L]=await Promise.all([z(N),z(P)]);F&&L?this.set(n,{fgImg:F,bgImg:L}):console.warn(`Skipping preload for invalid images at index: ${n}`)}catch(F){console.warn(`Error loading images at index ${n}:`,F)}}}catch(e){console.error("Error during image preloading:",e)}finally{this.isPreloading=!1}}}};function G(o){let e=0;return function t(i){try{e||(e=i);let n=i-e,{fps:l,frameTimes:r}=v(o.frameTimes,33,n);if(o.fps=l,o.frameTimes=r,n>=S-2){e+=S;let s=o.indexController.index;if(o.imageCache.has(s)){let{fgImg:d,bgImg:h}=o.imageCache.get(s);D(d,h),o.folderController.updateFolders(s,o.indexController.direction),o.indexController.increment(o.maxIndex),o.imageCache.sizeCurrent()<p/2&&(o.needsPreloading=!0)}else o.needsPreloading=!0}}catch(n){console.error("Error in renderLoop:",n)}requestAnimationFrame(t)}}function K(o){async function e(){o.needsPreloading&&(o.needsPreloading=!1,await o.imageCache.preloadImages()),setTimeout(e,100)}e()}async function w(){let o=w.state;if(o.renderLoopStarted)return;o.renderLoopStarted=!0,o.maxIndex=o.folderController.getMaxIndex(),o.indexController.setIndex(0,o.maxIndex),o.indexController.setDirection(1),o.imageCache.clear(),await o.imageCache.preloadImages(),K(o);let e=G(o);requestAnimationFrame(e)}async function k(o,e){let t={indexController:null,folderController:null,mainFolders:[],floatFolders:[],frameTimes:[],fps:0,needsPreloading:!1,renderLoopStarted:!1,imageCache:null,maxIndex:0};if(w.state=t,t.mainFolders=o.folders,t.floatFolders=e.folders,t.mainFolders.length===0||t.floatFolders.length===0)return console.error("No folders found in one or both JSON files."),!1;for(let i=0;i<t.mainFolders.length;i++){let n=t.mainFolders[i];if(!n.image_list||!Array.isArray(n.image_list)||n.image_list.length===0)return console.error(`Folder ${i} in mainFolders is missing a valid 'image_list' array.`),!1}for(let i=0;i<t.floatFolders.length;i++){let n=t.floatFolders[i];if(!n.image_list||!Array.isArray(n.image_list)||n.image_list.length===0)return console.error(`Folder ${i} in floatFolders is missing a valid 'image_list' array.`),!1}return t.folderController=new y(t.mainFolders,t.floatFolders),t.indexController=new I,t.imageCache=new E(p,{indexController:t.indexController,folderController:t.folderController,mainFolders:t.mainFolders,floatFolders:t.floatFolders}),t.folderController.onFolderChange(i=>{i.folderChanged&&(t.needsPreloading=!0)}),t.indexController.onIndexChange((i,n,l)=>{l.directionChanged&&(t.imageCache.clear(),console.log("Direction changed. Cache cleared."),t.needsPreloading=!0)}),console.log("Folders initialized successfully."),!0}var x={};async function X(){try{let o=await fetch($),e=await fetch(O);if(!o.ok||!e.ok)throw new Error("Failed to preload JSON files");x.mainData=await o.json(),x.floatData=await e.json()}catch(o){console.error("Error preloading JSON:",o),x={mainData:{folders:[]},floatData:{folders:[]}}}}function J(o){return o==="main"?x.mainData||{folders:[]}:o==="float"?x.floatData||{folders:[]}:(console.error(`Unknown JSON type: ${o}`),{folders:[]})}_();c.addEventListener("click",()=>{document.fullscreenElement?document.exitFullscreen():c.requestFullscreen().catch(o=>{console.error(`Error attempting to enable fullscreen mode: ${o.message} (${o.name})`)})});(async function(){try{await X();let e=J("main"),t=J("float"),i=await k(e,t);console.log("Initialization success:",i),i&&w()}catch(e){console.error("Error during initialization:",e)}})();})();
